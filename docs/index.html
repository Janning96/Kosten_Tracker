<!doctype html>
<html lang='de'>
<head>
  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1' />
  <title>Finance Import App — Barclays PDF</title>
  <link rel='stylesheet' href='./style.css' />
  <script src='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js' defer></script>
</head>
<body>
  <header class='container'>
    <h1>Barclays PDF Import</h1>
    <p>Stabiler Import aus der <strong>Umsatzübersicht</strong> deiner Barclays-Kreditkartenabrechnung (DE).</p>
  </header>
  <main class='container'>
    <section class='card'>
      <h2>1) Barclays-PDF auswählen</h2>
      <label class='btn'>
        <input id='barclays-file' type='file' accept='application/pdf,.pdf' hidden />
        Barclays PDF wählen
      </label>
      <p class='hint'>Erwartet Zeilen mit: <code>Belegdatum Valutadatum Beschreibung Betrag±</code> (Betrag mit Nachzeichen wie <code>23,11-</code>). Mehrzeilige Beschreibungen werden automatisch zusammengeführt.</p>
      <div class='actions'><button id='clear-all' class='secondary'>Alles löschen</button></div>
    </section>
    <section class='card'>
      <h2>2) Ergebnisse</h2>
      <div class='stats'><span id='count'>0</span> Buchungen gefunden</div>
      <div class='table-wrap'>
        <table id='tx-table'>
          <thead><tr><th>#</th><th>Original-Beschreibung</th><th>Bereinigt (editierbar)</th><th>Betrag</th><th>Valutadatum</th></tr></thead>
          <tbody id='tx-body'><tr id='empty-row'><td colspan='5' style='text-align:center; opacity:.7'>Noch keine Daten…</td></tr></tbody>
        </table>
      </div>
      <div class='actions'><button id='export-csv'>Als CSV exportieren</button></div>
    </section>
  </main>
  <footer class='container foot'><small>© 2025 – Static client-side app. PDF-Parsing via PDF.js.</small></footer>
  <script type='module'>
    import { extractPdfText } from './utils/pdf.js';
    import { exportToCsv } from './utils/csv.js';
    import { normalizeDescription } from './utils/normalize.js';
    import { parseBarclaysPdfRobust } from './parsers/barclays_pdf.js';
    const barcInput=document.getElementById('barclays-file');
    const txBody=document.getElementById('tx-body');
    const clearBtn=document.getElementById('clear-all');
    const exportBtn=document.getElementById('export-csv');
    const countEl=document.getElementById('count');
    let rows=[];
    function render(){
      txBody.innerHTML=''; countEl.textContent=String(rows.length);
      if(!rows.length){const tr=document.createElement('tr');tr.id='empty-row';const td=document.createElement('td');td.colSpan=5;td.style.textAlign='center';td.style.opacity=.7;td.textContent='Noch keine Daten…';tr.appendChild(td);txBody.appendChild(tr);return;}
      rows.forEach((r,i)=>{
        const tr=document.createElement('tr');
        const tdIdx=document.createElement('td'); tdIdx.textContent=i+1; tr.appendChild(tdIdx);
        const tdOrig=document.createElement('td'); tdOrig.textContent=r.original||''; tr.appendChild(tdOrig);
        const tdClean=document.createElement('td'); const input=document.createElement('input'); input.type='text'; input.value=r.clean||''; input.addEventListener('input',(e)=>{r.clean=e.target.value;}); tdClean.appendChild(input); tr.appendChild(tdClean);
        const tdAmt=document.createElement('td'); tdAmt.textContent=Number(r.amount).toFixed(2); tr.appendChild(tdAmt);
        const tdDt=document.createElement('td'); tdDt.textContent=r.postingDate; tr.appendChild(tdDt);
        txBody.appendChild(tr);
      });
    }
    function push(list){
      for(const tx of list){
        const desc=String(tx.description||'');
        if(desc.trim().toLowerCase()==='gutschrift manuelle lastschrift') continue;
        const clean=normalizeDescription(desc);
        rows.push({original:desc,clean,amount:Number(tx.amount),postingDate:tx.postingDate});
      }
      render();
    }
    async function handlePdf(){
      const file=barcInput.files?.[0]; if(!file) return;
      try{ const text=await extractPdfText(file); const list=parseBarclaysPdfRobust(text); rows=[]; push(list); }
      catch(err){ alert('Fehler beim Barclays-Import: '+(err?.message||err)); console.error(err); }
      finally{ barcInput.value=''; }
    }
    barcInput.addEventListener('change', handlePdf);
    clearBtn.addEventListener('click',()=>{rows=[];render();});
    exportBtn.addEventListener('click',()=>{
      if(!rows.length){alert('Keine Daten zum Export.');return;}
      const exportRows=rows.map(r=>({original:r.original,clean:r.clean,amount:Number(r.amount).toFixed(2),postingDate:r.postingDate}));
      exportToCsv(exportRows, `barclays_export_${new Date().toISOString().slice(0,10)}.csv`);
    });
    window.addEventListener('load',()=>{ if(!window['pdfjsLib']) alert('PDF.js konnte nicht geladen werden. Prüfe Internetverbindung oder binde pdf.min.js lokal ein.'); });
  </script>
</body></html>