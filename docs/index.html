<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finance Import App (PDF-only, v3)</title>
  <link rel="stylesheet" href="./style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
</head>
<body>
  <header class="container">
    <h1>Finance Import App</h1>
    <p>PDF-Import fÃ¼r N26 ðŸ‡©ðŸ‡ª & Barclays ðŸ‡©ðŸ‡ª â€“ optimiert auf deine August-PDFs.</p>
  </header>

  <main class="container">
    <section class="card">
      <h2>1) PDF importieren</h2>
      <div class="import-grid">
        <div>
          <label class="btn">
            <input id="n26-file" type="file" accept="application/pdf,.pdf" hidden />
            N26 PDF wÃ¤hlen
          </label>
          <p class="hint">Erkennt Zeilen wie: â€žWertstellung DD.MM.YYYY DD.MM.YYYY Â±123,45â‚¬â€œ (2. Datum = Verbuchung).</p>
        </div>
        <div>
          <label class="btn">
            <input id="barclays-file" type="file" accept="application/pdf,.pdf" hidden />
            Barclays PDF wÃ¤hlen
          </label>
          <p class="hint">Liest â€žUmsatzÃ¼bersichtâ€œ (Belegdatum, Valuta, Beschreibung, BetragÂ± am Zeilenende).</p>
        </div>
      </div>
      <div class="actions">
        <button id="clear-all" class="secondary">Alles lÃ¶schen</button>
      </div>
    </section>

    <section class="card">
      <h2>2) Bereinigte Buchungen prÃ¼fen & korrigieren</h2>
      <div class="table-wrap">
        <table id="tx-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Original-Beschreibung</th>
              <th>Bereinigt (editierbar)</th>
              <th>Betrag</th>
              <th>Buchungsdatum</th>
              <th>Quelle</th>
            </tr>
          </thead>
          <tbody id="tx-body">
            <tr id="empty-row"><td colspan="6" style="text-align:center; opacity:.7">Noch keine Datenâ€¦</td></tr>
          </tbody>
        </table>
      </div>
      <div class="actions">
        <button id="export-csv">Als CSV exportieren</button>
      </div>
    </section>

    <section class="card small">
      <h3>Einstellungen (Permanent)</h3>
      <ul class="bullets">
        <li><strong>Barclays-PDF:</strong> Ignoriere exakt â€žGutschrift Manuelle Lastschriftâ€œ.</li>
        <li><strong>N26-PDF (deutsch):</strong> Nutze bei zwei Datumswerten das <em>zweite</em> Datum als Verbuchungsdatum.</li>
        <li><strong>Normalisierung:</strong> HÃ¤ndler vereinfachen (Amazon, PayPal, REWE, â€¦); editierbar.</li>
      </ul>
    </section>
  </main>

  <footer class="container foot">
    <small>Â© 2025 â€“ Static client-side app. PDF-Parsing via PDF.js (CDN).</small>
  </footer>

  <script type="module">
    import { extractPdfText } from './utils/pdf.js';
    import { normalizeDescription } from './utils/normalize.js';
    import { exportToCsv } from './utils/csv.js';
    import { parseN26PdfText } from './parsers/n26_pdf.js';
    import { parseBarclaysPdfText } from './parsers/barclays_pdf.js';

    const n26Input = document.getElementById('n26-file');
    const barcInput = document.getElementById('barclays-file');
    const txBody   = document.getElementById('tx-body');
    const clearBtn = document.getElementById('clear-all');
    const exportBtn= document.getElementById('export-csv');

    let rows = [];

    function render() {
      txBody.innerHTML = '';
      if (!rows.length) {
        const tr = document.createElement('tr');
        tr.id = 'empty-row';
        const td = document.createElement('td');
        td.colSpan = 6; td.style.textAlign = 'center'; td.style.opacity = .7;
        td.textContent = 'Noch keine Datenâ€¦';
        tr.appendChild(td); txBody.appendChild(tr); return;
      }
      rows.forEach((r, i) => {
        const tr = document.createElement('tr');
        const tdIdx = document.createElement('td'); tdIdx.textContent = i + 1; tr.appendChild(tdIdx);
        const tdOrig = document.createElement('td'); tdOrig.textContent = r.original || ''; tr.appendChild(tdOrig);
        const tdClean = document.createElement('td');
        const input = document.createElement('input'); input.type = 'text'; input.value = r.clean || '';
        input.addEventListener('input', (e) => { r.clean = e.target.value; });
        tdClean.appendChild(input); tr.appendChild(tdClean);
        const tdAmt = document.createElement('td'); tdAmt.textContent = Number(r.amount).toFixed(2); tr.appendChild(tdAmt);
        const tdDt = document.createElement('td'); tdDt.textContent = r.postingDate; tr.appendChild(tdDt);
        const tdSrc = document.createElement('td'); tdSrc.textContent = r.source; tr.appendChild(tdSrc);
        txBody.appendChild(tr);
      });
    }

    function pushTransactions(list) {
      for (const tx of list) {
        const desc = String(tx.description || '');
        if (tx.source === 'N26' && /barclays/i.test(desc)) continue;
        if (tx.source === 'Barclays' && desc.trim().toLowerCase() === 'gutschrift manuelle lastschrift') continue;
        const clean = normalizeDescription(desc);
        rows.push({ original: desc, clean, amount: Number(tx.amount), postingDate: tx.postingDate, source: tx.source });
      }
      render();
    }

    async function handlePdf(input, parseFn, sourceName) {
      const file = input.files?.[0]; if (!file) return;
      try {
        const text = await extractPdfText(file);
        const list = parseFn(text);
        pushTransactions(list);
      } catch (err) {
        alert(`Fehler beim ${sourceName}-Import: ` + (err?.message || err));
        console.error(err);
      } finally {
        input.value = '';
      }
    }

    n26Input.addEventListener('change', (e) => handlePdf(e.target, parseN26PdfText, 'N26'));
    barcInput.addEventListener('change', (e) => handlePdf(e.target, parseBarclaysPdfText, 'Barclays'));

    clearBtn.addEventListener('click', () => { rows = []; render(); });
    exportBtn.addEventListener('click', () => {
      if (!rows.length) { alert('Keine Daten zum Export.'); return; }
      const exportRows = rows.map(r => ({ ...r, amount: Number(r.amount).toFixed(2) }));
      const name = `export_${new Date().toISOString().slice(0,10)}.csv`;
      exportToCsv(exportRows, name);
    });

    window.addEventListener('load', () => {
      if (!window['pdfjsLib']) {
        alert('PDF.js konnte nicht geladen werden. PrÃ¼fe Internetverbindung oder binde pdf.min.js lokal ein.');
      }
    });
  </script>
</body>
</html>
