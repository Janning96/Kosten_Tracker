<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finance Import App</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <header class="container">
    <h1>Finance Import App</h1>
    <p>Kleines, statisches Tool zum Import & Bereinigen (N26, Barclays) – GitHub Pages ready.</p>
  </header>

  <main class="container">
    <section class="card">
      <h2>1) Daten importieren</h2>
      <div class="import-grid">
        <div>
          <label class="btn">
            <input id="n26-file" type="file" accept="application/pdf,.pdf" hidden />
            N26 PDF wählen
          </label>
          <p class="hint">Erkennt automatisch Hauptkonto + Spaces. Tabellen: <em>Description | Posting Date | Amount</em> (getrennte oder kombinierte Zeilen).</p>
        </div>

        <div>
          <label class="btn">
            <input id="barclays-file" type="file" accept=".csv,text/csv" hidden />
            Barclays CSV wählen
          </label>
          <p class="hint">Ignoriert automatisch: <code>Gutschrift Manuelle Lastschrift</code>.</p>
        </div>
      </div>
      <div class="actions">
        <button id="clear-all" class="secondary">Alles löschen</button>
      </div>
    </section>

    <section class="card">
      <h2>2) Bereinigte Buchungen prüfen & korrigieren</h2>
      <div class="table-wrap">
        <table id="tx-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Original-Beschreibung</th>
              <th>Bereinigt (editierbar)</th>
              <th>Betrag</th>
              <th>Buchungsdatum</th>
              <th>Quelle</th>
            </tr>
          </thead>
          <tbody id="tx-body">
            <tr id="empty-row"><td colspan="6" style="text-align:center; opacity:.7">Noch keine Daten…</td></tr>
          </tbody>
        </table>
      </div>
      <div class="actions">
        <button id="export-csv">Als CSV exportieren</button>
      </div>
    </section>

    <section class="card small">
      <h3>Einstellungen (Permanent)</h3>
      <ul class="bullets">
        <li>Barclays-Import: Ignoriere <code>Gutschrift Manuelle Lastschrift</code>.</li>
        <li>N26-Import: Ignoriere Buchungen, deren Beschreibung <code>Barclays</code> enthält.</li>
        <li>N26 Parser: Scanne gesamtes Dokument (Main + Spaces), erkenne Tabellen <em>Description | Posting Date | Amount</em>, parse getrennte & kombinierte Zeilen, normalisiere Unicode-Minus & NBSP.</li>
        <li>Beschreibung normalisieren: Speichere nur Händler-Hauptnamen (z. B. <em>AMAZON PAYMENTS EUROPE S.C.A.</em> → <em>Amazon</em>, <em>PayPal Europe S.a.r.l. et Cie S.C.A</em> → <em>PayPal</em>…). Korrigierbar in der Tabelle.</li>
      </ul>
    </section>
  </main>

  <footer class="container foot">
    <small>© 2025 – Static, client-side only. Keine externen Abhängigkeiten.</small>
  </footer>

  <script type="module">
    import { normalizeDescription } from './utils/normalize.js';
    import { exportToCsv } from './utils/csv.js';
    import { parseN26Pdf } from './parsers/n26.js';
    import { parseBarclaysCsv } from './parsers/barclays.js';

    const n26Input = document.getElementById('n26-file');
    const barcInput = document.getElementById('barclays-file');
    const txBody   = document.getElementById('tx-body');
    const clearBtn = document.getElementById('clear-all');
    const exportBtn= document.getElementById('export-csv');

    /** In-Memory Store */
    let rows = [];

    function render() {
      txBody.innerHTML = '';
      if (!rows.length) {
        const tr = document.createElement('tr');
        tr.id = 'empty-row';
        const td = document.createElement('td');
        td.colSpan = 6; td.style.textAlign = 'center'; td.style.opacity = .7;
        td.textContent = 'Noch keine Daten…';
        tr.appendChild(td); txBody.appendChild(tr); return;
      }

      rows.forEach((r, i) => {
        const tr = document.createElement('tr');
        // #
        const tdIdx = document.createElement('td');
        tdIdx.textContent = i + 1; tr.appendChild(tdIdx);
        // Original
        const tdOrig = document.createElement('td');
        tdOrig.textContent = r.original || ''; tr.appendChild(tdOrig);
        // Clean (editable)
        const tdClean = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'text'; input.value = r.clean || '';
        input.addEventListener('input', (e) => { r.clean = e.target.value; });
        tdClean.appendChild(input); tr.appendChild(tdClean);
        // Amount
        const tdAmt = document.createElement('td'); tdAmt.textContent = r.amount; tr.appendChild(tdAmt);
        // Date
        const tdDt = document.createElement('td'); tdDt.textContent = r.postingDate; tr.appendChild(tdDt);
        // Source
        const tdSrc = document.createElement('td'); tdSrc.textContent = r.source; tr.appendChild(tdSrc);

        txBody.appendChild(tr);
      });
    }

    function pushTransactions(list) {
      // Apply merchant normalization + permanent ignore rules
      for (const tx of list) {
        const desc = (tx.description || '').toString();
        // N26 ignore rule: description contains 'Barclays'
        if (tx.source === 'N26' && /barclays/i.test(desc)) continue;
        // Barclays ignore rule: exact 'Gutschrift Manuelle Lastschrift'
        if (tx.source === 'Barclays' && desc.trim().toLowerCase() === 'gutschrift manuelle lastschrift') continue;

        const clean = normalizeDescription(desc);
        rows.push({
          original: desc,
          clean,
          amount: tx.amount,
          postingDate: tx.postingDate,
          source: tx.source,
        });
      }
      render();
    }

    n26Input.addEventListener('change', async (e) => {
      const file = e.target.files?.[0]; if (!file) return;
      try {
        const list = await parseN26Pdf(file);
        pushTransactions(list);
      } catch (err) {
        alert('Fehler beim N26-Import: ' + (err?.message || err));
        console.error(err);
      } finally {
        e.target.value = '';
      }
    });

    barcInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0]; if (!file) return;
      try {
        const list = await parseBarclaysCsv(file);
        pushTransactions(list);
      } catch (err) {
        alert('Fehler beim Barclays-Import: ' + (err?.message || err));
        console.error(err);
      } finally {
        e.target.value = '';
      }
    });

    clearBtn.addEventListener('click', () => { rows = []; render(); });

    exportBtn.addEventListener('click', () => {
      if (!rows.length) { alert('Keine Daten zum Export.'); return; }
      const exportRows = rows.map(r => ({
        original: r.original,
        clean: r.clean,
        amount: r.amount,
        postingDate: r.postingDate,
        source: r.source,
      }));
      const name = `export_${new Date().toISOString().slice(0,10)}.csv`;
      exportToCsv(exportRows, name);
    });

    render();
  </script>
</body>
</html>
